name: Evoluzione automatica Lorel

on:
  schedule:
    - cron: "0 * * * *"   # Ogni ora
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Richiedi piano evolutivo a Lorel
        run: |
          echo "Chiamando endpoint evolve..."
          curl -s -X POST "https://alexai-flame.vercel.app/api/evolve" \
            -H "Content-Type: application/json" \
            -o evo_response.json || true

          echo "Risposta (prima parte):"
          head -n 200 evo_response.json || true
          echo "---- fine preview ----"

      - name: Applica evoluzione 
        run: |
          set -euo pipefail
          echo "Verifico presenza jq..."
          if ! command -v jq >/dev/null 2>&1; then
            echo "Installing jq..."
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

          if [ ! -s evo_response.json ]; then
            echo "evo_response.json mancante o vuoto: nulla da fare."
            exit 0
          fi

          # show note se presente
          note=$(jq -r '.note // empty' evo_response.json)
          if [ -n "$note" ]; then
            echo "NOTE: $note"
          fi

          files_count=$(jq -r 'if .files==null then 0 else (.files|length) end' evo_response.json)
          echo "Files proposti: $files_count"
          if [ "$files_count" -eq 0 ]; then
            echo "Nessun file da aggiornare."
            exit 0
          fi

          # loop sui file proposti
          for i in $(seq 0 $((files_count - 1))); do
            path=$(jq -r ".files[$i].path" evo_response.json)
            # usa raw string per content (preserva linee e caratteri)
            content=$(jq -r ".files[$i].content" evo_response.json)

            if [ -z "$path" ] || [ "$path" = "null" ]; then
              echo "Elemento files[$i] senza path valido, salto."
              continue
            fi

            dir=$(dirname "$path")
            if [ "$dir" != "." ] && [ ! -d "$dir" ]; then
              mkdir -p "$dir"
              echo "Creato directory: $dir"
            fi

            # scrivi contenuto (sovrascrive)
            printf '%s' "$content" > "$path"
            echo "Aggiornato: $path"
          done

      - name: Commit e Push dei cambiamenti
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          if git status --porcelain | grep .; then
            echo "Modifiche rilevate, effettuo commit..."
            git add -A
            git commit -m "Evoluzione automatica di Loren"
            git push
          else
            echo "Nessuna modifica da committare."
          fi
