<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorel Axun</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script src="https://unpkg.com/sentiment@5.0.2/min/sentiment.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

    <style>
        :root {
            --light-bg: #f0f2f5;
            --light-surface: #ffffff;
            --light-text: #050505;
            --light-subtle-text: #65676b;
            --light-accent: #0866ff;
            --light-accent-text: #ffffff;
            --light-user-message-bg: #e7f3ff;
            --light-user-message-text: #050505;
            --light-ai-message-bg: #f0f0f0;
            --light-ai-message-text: #050505;
            --light-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --light-border: #ced0d4;

            --dark-bg: #18191a;
            --dark-surface: #242526;
            --dark-text: #e4e6eb;
            --dark-subtle-text: #b0b3b8;
            --dark-accent: #2374e1;
            --dark-accent-text: #ffffff;
            --dark-user-message-bg: #263951;
            --dark-user-message-text: #e4e6eb;
            --dark-ai-message-bg: #3a3b3c;
            --dark-ai-message-text: #e4e6eb;
            --dark-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --dark-border: #3e4042;

            --bg-color: var(--light-bg);
            --surface-color: var(--light-surface);
            --text-color: var(--light-text);
            --subtle-text-color: var(--light-subtle-text);
            --accent-color: var(--light-accent);
            --accent-text-color: var(--light-accent-text);
            --user-message-bg: var(--light-user-message-bg);
            --user-message-text: var(--light-user-message-text);
            --ai-message-bg: var(--light-ai-message-bg);
            --ai-message-text: var(--light-ai-message-text);
            --shadow: var(--light-shadow);
            --border-color: var(--light-border);
        }

        html[data-theme='dark'] {
            --bg-color: var(--dark-bg);
            --surface-color: var(--dark-surface);
            --text-color: var(--dark-text);
            --subtle-text-color: var(--dark-subtle-text);
            --accent-color: var(--dark-accent);
            --accent-text-color: var(--dark-accent-text);
            --user-message-bg: var(--dark-user-message-bg);
            --user-message-text: var(--dark-user-message-text);
            --ai-message-bg: var(--dark-ai-message-bg);
            --ai-message-text: var(--dark-ai-message-text);
            --shadow: var(--dark-shadow);
            --border-color: var(--dark-border);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s ease;
            --gradient-start: #89f7fe;
            --gradient-end: #66a6ff;
            --spotlight-size: 0px;
            --mouse-x: 50%;
            --mouse-y: 50%;
            background: 
                radial-gradient(circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) calc(var(--spotlight-size) * 0.5), transparent calc(var(--spotlight-size))),
                linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            background-size: cover, 200% 200%;
            animation: gradient-animation 15s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%, 0% 50%; }
            50% { background-position: 0% 50%, 100% 50%; }
            100% { background-position: 0% 50%, 0% 50%; }
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-color);
        }

        #theme-toggle-button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        #theme-toggle-button:hover {
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            border-color: var(--accent-color);
        }

        #chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- Start of new message bubble styles --- */
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            max-width: 80%;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }

        .message.user {
            background-color: var(--user-message-bg);
            color: var(--user-message-text);
            align-self: flex-end;
            margin-right: 10px; /* Make space for the tail */
        }

        .message.ai {
            background-color: var(--ai-message-bg);
            color: var(--ai-message-text);
            align-self: flex-start;
            margin-left: 10px; /* Make space for the tail */
        }

        /* The "tail" of the bubble using a CSS triangle */
        .message:after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-bottom: 0;
        }

        .message.user:after {
            right: -10px;
            border-top-color: var(--user-message-bg);
        }

        .message.ai:after {
            left: -10px;
            border-top-color: var(--ai-message-bg);
        }
        /* --- End of new message bubble styles --- */

        .message.ai pre {
            background-color: #1e1e1e;
            color: #dcdcdc;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
        }

        .message.ai code {
            font-family: 'Courier New', Courier, monospace;
        }

        .copy-code-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message.ai pre:hover .copy-code-button {
            opacity: 1;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin-left: 10px;
            align-self: flex-start;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: var(--subtle-text-color);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .chat-input {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
        }

        #user-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 10px 15px;
            font-size: 1rem;
            resize: none;
            background-color: var(--surface-color);
            color: var(--text-color);
            max-height: 150px;
            overflow-y: auto;
            font-family: inherit;
        }

        #user-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-alpha, rgba(8, 102, 255, 0.2));
        }

        #send-button {
            margin-left: 10px;
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        #send-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <header class="chat-header">
            <h1>Lorel Axun</h1>
            <button id="theme-toggle-button">Tema</button>
        </header>
        <div id="chat-messages"></div>
        <div class="chat-input">
            <textarea id="user-input" placeholder="Scrivi un messaggio..." rows="1"></textarea>
            <button id="send-button">Invia</button>
        </div>
    </div>

    <script>
        const sentiment = new Sentiment();

        window.onload = () => {
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const sendButton = document.getElementById('send-button');
            const userInput = document.getElementById('user-input');

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Load chat history
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                document.getElementById('chat-messages').innerHTML = savedHistory;
                attachCopyListeners();
            } else {
                addMessage('Ciao! Sono Lorel Axun. Come posso aiutarti oggi? Prova a chiedermi `wiki: Intelligenza Artificiale` o `sentiment: Questa è una bellissima giornata`.', 'ai');
            }
            scrollToBottom();

            themeToggleButton.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });

            sendButton.addEventListener('click', handleUserInput);
            userInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleUserInput();
                }
            });

            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
            });

            document.body.addEventListener('mousemove', (e) => {
                const body = document.body;
                body.style.setProperty('--mouse-x', `${e.clientX}px`);
                body.style.setProperty('--mouse-y', `${e.clientY}px`);
                body.style.setProperty('--spotlight-size', '400px');
            });

            document.body.addEventListener('mouseleave', () => {
                document.body.style.setProperty('--spotlight-size', '0px');
            });
        };

        function saveChatHistory() {
            const chatMessages = document.getElementById('chat-messages').innerHTML;
            localStorage.setItem('chatHistory', chatMessages);
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(text, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);

            if (sender === 'ai') {
                messageElement.innerHTML = marked.parse(text);
            } else {
                const textNode = document.createTextNode(text);
                messageElement.appendChild(textNode);
            }

            chatMessages.appendChild(messageElement);
            attachCopyListeners();
            scrollToBottom();
            saveChatHistory();
        }

        function attachCopyListeners() {
            document.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.copy-code-button')) return; // Don't add twice

                const button = document.createElement('button');
                button.innerText = 'Copia';
                button.className = 'copy-code-button';
                pre.appendChild(button);

                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        button.innerText = 'Copiato!';
                        setTimeout(() => { button.innerText = 'Copia'; }, 2000);
                    });
                });
            });
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            typingIndicator.id = 'typing';
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function updateGradient(score) {
            const body = document.body;
            if (score > 0) { // Positive
                body.style.setProperty('--gradient-start', '#ffecd2');
                body.style.setProperty('--gradient-end', '#fcb69f');
            } else if (score < 0) { // Negative
                body.style.setProperty('--gradient-start', '#a1c4fd');
                body.style.setProperty('--gradient-end', '#c2e9fb');
            } else { // Neutral
                body.style.setProperty('--gradient-start', '#89f7fe');
                body.style.setProperty('--gradient-end', '#66a6ff');
            }
        }

        async function getAiResponse(input) {
            const lowerInput = input.toLowerCase().trim();

            if (lowerInput.startsWith('wiki:')) {
                const query = input.substring(5).trim();
                if (!query) return 'Per favore, specifica un termine da cercare su Wikipedia.';
                try {
                    const response = await fetch(`https://it.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Pagina non trovata o errore di rete.');
                    const data = await response.json();
                    return data.extract || 'Non ho trovato un riassunto per questa pagina.';
                } catch (error) {
                    return `Si è verificato un errore durante la ricerca su Wikipedia: ${error.message}`;
                }
            } else if (lowerInput.startsWith('sentiment:')) {
                const textToAnalyze = input.substring(10).trim();
                if (!textToAnalyze) return 'Per favore, fornisci del testo da analizzare.';
                const result = sentiment.analyze(textToAnalyze);
                updateGradient(result.score);
                return `Analisi del sentiment:\n- Punteggio: ${result.score}\n- Comparativo: ${result.comparative.toFixed(2)}\n- Parole positive: ${result.positive.join(', ') || 'Nessuna'}\n- Parole negative: ${result.negative.join(', ') || 'Nessuna'}`;
            } else if (lowerInput.startsWith('news:')) {
                return 'La funzione notizie è in fase di sviluppo e non è ancora disponibile.';
            } else {
                return 'Comando non riconosciuto. Prova con `wiki: <termine>` o `sentiment: <testo>`.';
            }
        }

        async function handleUserInput() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();

            if (message) {
                addMessage(message, 'user');
                userInput.value = '';
                userInput.style.height = 'auto';

                showTypingIndicator();

                // Analyze sentiment of user message for gradient change
                const userSentiment = sentiment.analyze(message);
                updateGradient(userSentiment.score);

                setTimeout(async () => {
                    const aiResponse = await getAiResponse(message);
                    removeTypingIndicator();
                    addMessage(aiResponse, 'ai');
                }, 1500);
            }
        }

        // Configure marked to use highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-',
        });
    </script>

</body>
</html>