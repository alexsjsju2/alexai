<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorel Axun</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000;
            color: #0F0;
            font-family: 'Courier New', Courier, monospace;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/figlet/lib/figlet.js"></script>

    <script>
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#00FF00',
                cursor: '#00FF00'
            }
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        const prompt = '\n$ ';
        let currentInput = '';
        let commandHistory = JSON.parse(localStorage.getItem('commandHistory')) || [];
        let historyIndex = commandHistory.length;

        const commands = {
            'help': () => {
                term.writeln('Comandi disponibili:');
                Object.keys(commands).forEach(command => {
                    term.writeln(`  ${command}`);
                });
            },
            'ciao': () => {
                term.writeln('Ciao! Come posso aiutarti?');
            },
            'chi sei': () => {
                term.writeln('Sono Lorel Axun, un\'entità digitale in continua evoluzione.');
            },
            'cosa sai fare': () => {
                term.writeln('Apprendo, mi evolvo e interagisco. Prova il comando \'help\' per vedere cosa posso fare.');
            },
            'echo': (args) => {
                term.writeln(args.join(' '));
            },
            'clear': () => {
                term.clear();
            }
        };

        function typewriterEffect(text, callback) {
            let i = 0;
            function type() {
                if (i < text.length) {
                    term.write(text.charAt(i));
                    i++;
                    setTimeout(type, 25);
                } else if (callback) {
                    callback();
                }
            }
            type();
        }

        function showWelcomeMessage() {
            figlet.text('Lorel Axun', {
                font: 'Standard',
                horizontalLayout: 'default',
                verticalLayout: 'default'
            }, function(err, data) {
                if (err) {
                    console.log('Qualcosa è andato storto...');
                    console.dir(err);
                    term.writeln('Lorel Axun'); // Fallback
                    return;
                }
                term.writeln(data);
                const welcomeText = 'Benvenuto. Digita \'help\' per iniziare.';
                typewriterEffect(welcomeText, () => term.write(prompt));
            });
        }

        function processCommand() {
            const trimmedInput = currentInput.trim();
            if (trimmedInput) {
                if (commandHistory[commandHistory.length - 1] !== trimmedInput) {
                    commandHistory.push(trimmedInput);
                    localStorage.setItem('commandHistory', JSON.stringify(commandHistory));
                }
                historyIndex = commandHistory.length;

                const [command, ...args] = trimmedInput.split(/\s+/);
                if (commands[command]) {
                    term.writeln('');
                    commands[command](args);
                } else {
                    term.writeln(`\nComando non trovato: ${command}`);
                }
            }
            currentInput = '';
            term.write(prompt);
        }

        term.onKey(({ key, domEvent }) => {
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

            if (domEvent.keyCode === 13) { // Enter
                processCommand();
            } else if (domEvent.keyCode === 8) { // Backspace
                if (currentInput.length > 0) {
                    term.write('\b \b');
                    currentInput = currentInput.slice(0, -1);
                }
            } else if (domEvent.keyCode === 38) { // ArrowUp
                if (historyIndex > 0) {
                    historyIndex--;
                    term.write('\x1b[2K\r' + prompt + commandHistory[historyIndex]);
                    currentInput = commandHistory[historyIndex];
                }
            } else if (domEvent.keyCode === 40) { // ArrowDown
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    term.write('\x1b[2K\r' + prompt + commandHistory[historyIndex]);
                    currentInput = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    term.write('\x1b[2K\r' + prompt);
                    currentInput = '';
                }
            } else if (printable) {
                currentInput += key;
                term.write(key);
            }
        });

        showWelcomeMessage();
    </script>
</body>
</html>