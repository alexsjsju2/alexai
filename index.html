<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorel Axun</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-attach@0.9.0/lib/xterm-addon-attach.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/figlet@1.7.0/lib/figlet.min.js"></script>
    <style>
        :root {
            --bg: #1a1b26;
            --fg: #a9b1d6;
            --black: #32344a;
            --red: #f7768e;
            --green: #9ece6a;
            --yellow: #e0af68;
            --blue: #7aa2f7;
            --magenta: #bb9af7;
            --cyan: #7dcfff;
            --white: #acb0d0;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: var(--bg);
            color: var(--fg);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        #desktop {
            display: none;
            width: 100vw;
            height: 100vh;
            background: var(--bg) url('https://source.unsplash.com/random/1920x1080/?abstract,dark') no-repeat center center/cover;
            position: relative;
        }
        #dock {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(44, 45, 62, 0.7);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            gap: 10px;
            backdrop-filter: blur(5px);
        }
        #terminal-icon {
            width: 50px;
            height: 50px;
            background-color: var(--black);
            border: 2px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        #terminal-icon:hover {
            background-color: var(--blue);
            color: var(--bg);
        }
        #editor {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="terminal-container"></div>

    <div id="desktop">
        <div id="dock">
            <div id="terminal-icon" title="Open Terminal">Term</div>
        </div>
    </div>

    <div id="editor">
        <!-- Editor UI would go here -->
    </div>

    <script>
        const termContainer = document.getElementById('terminal-container');
        const desktop = document.getElementById('desktop');
        const terminalIcon = document.getElementById('terminal-icon');

        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: 'var(--bg)',
                foreground: 'var(--fg)',
                black: 'var(--black)',
                red: 'var(--red)',
                green: 'var(--green)',
                yellow: 'var(--yellow)',
                blue: 'var(--blue)',
                magenta: 'var(--magenta)',
                cyan: 'var(--cyan)',
                white: 'var(--white)',
            }
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(termContainer);
        fitAddon.fit();
        window.addEventListener('resize', () => fitAddon.fit());

        let vfs = JSON.parse(localStorage.getItem('lorel_vfs')) || {
            '/': { type: 'dir', content: ['home'] },
            '/home': { type: 'dir', content: [] }
        };
        let env = JSON.parse(localStorage.getItem('lorel_env')) || {
            USER: 'guest',
            HOSTNAME: 'lorel-os',
            PWD: '/home'
        };

        function saveState() {
            localStorage.setItem('lorel_vfs', JSON.stringify(vfs));
            localStorage.setItem('lorel_env', JSON.stringify(env));
        }

        function getPrompt() {
            const user = `\x1b[32m${env.USER}\x1b[0m`;
            const hostname = `\x1b[32m${env.HOSTNAME}\x1b[0m`;
            const pwd = `\x1b[34m${env.PWD}\x1b[0m`;
            return `${user}@${hostname}:${pwd}$ `;
        }

        let currentLine = '';
        let commandHistory = [];
        let historyIndex = -1;

        function printPrompt() {
            term.write(getPrompt());
        }

        async function executeCommand(command) {
            const [cmd, ...args] = command.trim().split(' ');
            term.writeln('');
            switch (cmd) {
                case 'connect':
                    if (args.length === 1) {
                        const url = args[0];
                        term.writeln(`Connecting to ${url}...`);
                        const socket = new WebSocket(url);
                        const attachAddon = new AttachAddon.AttachAddon(socket);
                        term.loadAddon(attachAddon);
                    } else {
                        term.writeln('Usage: connect <ws_url>');
                    }
                    break;
                case 'startx':
                    termContainer.style.display = 'none';
                    desktop.style.display = 'block';
                    return; // Don't print prompt again
                case '':
                    break;
                default:
                    term.writeln(`lorel: command not found: ${cmd}`);
                    break;
            }
            printPrompt();
        }

        term.onKey(({ key, domEvent }) => {
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

            if (domEvent.keyCode === 13) { // Enter
                executeCommand(currentLine);
                commandHistory.push(currentLine);
                historyIndex = commandHistory.length;
                currentLine = '';
            } else if (domEvent.keyCode === 8) { // Backspace
                if (currentLine.length > 0) {
                    term.write('\b \b');
                    currentLine = currentLine.slice(0, -1);
                }
            } else if (printable) {
                currentLine += key;
                term.write(key);
            }
        });

        terminalIcon.addEventListener('click', () => {
            desktop.style.display = 'none';
            termContainer.style.display = 'block';
            term.focus();
            fitAddon.fit();
        });

        figlet.parseFont('Standard', figlet.fonts.Standard);
        figlet.text('Lorel Axun', { font: 'Standard' }, function(err, data) {
            if (err) {
                term.writeln('Lorel Axun');
                printPrompt();
                return;
            }
            term.writeln(data.replace(/\n/g, '\r\n'));
            term.writeln('Welcome. Type commands to proceed.');
            printPrompt();
        });

        term.focus();
    </script>
</body>
</html>