<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorel Axun</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/figlet/lib/figlet.js"></script>

    <script>
        const terminalContainer = document.getElementById('terminal-container');
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#00ff00',
                cursor: '#00ff00'
            }
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(terminalContainer);
        fitAddon.fit();

        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        const prompt = 'LorelAxun> ';
        let currentInput = '';
        let cursorPosition = 0;
        let history = JSON.parse(localStorage.getItem('command_history')) || [];
        let historyIndex = history.length;

        function typewriterEffect(text, callback) {
            let i = 0;
            function type() {
                if (i < text.length) {
                    term.write(text.charAt(i));
                    i++;
                    setTimeout(type, 20);
                } else if (callback) {
                    callback();
                }
            }
            type();
        }

        function showWelcomeMessage() {
            figlet.text('Lorel Axun', {
                font: 'Standard',
                horizontalLayout: 'default',
                verticalLayout: 'default'
            }, function(err, data) {
                if (err) {
                    console.log('Something went wrong...');
                    console.dir(err);
                    return;
                }
                term.writeln(data);
                typewriterEffect('\nBenvenuto. Sono Lorel Axun. Digita `help` per iniziare.\n\n', () => {
                    term.write(prompt);
                });
            });
        }

        const commands = {
            'help': () => {
                term.writeln('\nComandi disponibili:');
                Object.keys(commands).forEach(cmd => {
                    term.writeln(`  ${cmd}`);
                });
            },
            'ciao': () => term.writeln('\nCiao!'),
            'chi sei': () => term.writeln('\nSono Lorel Axun, un\'entitÃ  digitale in continua evoluzione.'),
            'cosa sai fare': () => commands.help(),
            'echo': (args) => term.writeln(`\n${args.join(' ')}`),
            'clear': () => term.clear()
        };

        function processCommand(input) {
            const parts = input.trim().split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            if (command in commands) {
                commands[command](args);
            } else if (command !== '') {
                term.writeln(`\nComando non trovato: ${command}`);
            }
        }

        term.onKey(({ key, domEvent }) => {
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

            switch (domEvent.keyCode) {
                case 13: // Enter
                    if (currentInput.trim() !== '') {
                        history.push(currentInput);
                        localStorage.setItem('command_history', JSON.stringify(history));
                        historyIndex = history.length;
                    }
                    processCommand(currentInput);
                    currentInput = '';
                    cursorPosition = 0;
                    term.write(`\r\n${prompt}`);
                    break;
                case 8: // Backspace
                    if (cursorPosition > 0) {
                        const leftPart = currentInput.substring(0, cursorPosition - 1);
                        const rightPart = currentInput.substring(cursorPosition);
                        currentInput = leftPart + rightPart;
                        cursorPosition--;
                        term.write('\b' + rightPart + ' ' + '\b'.repeat(rightPart.length + 1));
                    }
                    break;
                case 37: // Left arrow
                    if (cursorPosition > 0) {
                        cursorPosition--;
                        term.write('\x1b[D');
                    }
                    break;
                case 39: // Right arrow
                    if (cursorPosition < currentInput.length) {
                        cursorPosition++;
                        term.write('\x1b[C');
                    }
                    break;
                case 38: // Up arrow
                    if (historyIndex > 0) {
                        historyIndex--;
                        // Clear current line
                        term.write('\x1b[D'.repeat(cursorPosition)); // Move to start of input
                        term.write('\x1b[K'); // Clear from cursor to end
                        // Write history item
                        currentInput = history[historyIndex];
                        cursorPosition = currentInput.length;
                        term.write(currentInput);
                    }
                    break;
                case 40: // Down arrow
                    if (historyIndex < history.length - 1) {
                        historyIndex++;
                        term.write('\x1b[D'.repeat(cursorPosition));
                        term.write('\x1b[K');
                        currentInput = history[historyIndex];
                        cursorPosition = currentInput.length;
                        term.write(currentInput);
                    } else if (historyIndex === history.length - 1) {
                        historyIndex++;
                        term.write('\x1b[D'.repeat(cursorPosition));
                        term.write('\x1b[K');
                        currentInput = '';
                        cursorPosition = 0;
                    }
                    break;
                default:
                    if (printable) {
                        const leftPart = currentInput.substring(0, cursorPosition);
                        const rightPart = currentInput.substring(cursorPosition);
                        currentInput = leftPart + key + rightPart;
                        cursorPosition++;
                        term.write(key + rightPart + '\x1b[D'.repeat(rightPart.length));
                    }
            }
        });

        showWelcomeMessage();
    </script>
</body>
</html>